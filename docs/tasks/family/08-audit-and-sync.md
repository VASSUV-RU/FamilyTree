# 08 — Аудит действий семьи и синхронизация сессий

Цель
- Отслеживать изменения в семьях и синхронизировать активные сессии/кеши прав.

Требования
- Добавить аудит-лог (таблица `family_audit`) с типами событий: `family_created`, `invite_sent`, `member_role_changed`, `member_removed`, `profile_updated`.
- Сервис `FamilyAuditService` записывает события и публикует доменные события (Spring events/kafka? todo).
- Реализовать обработчики, которые при изменениях пересобирают `sess:{jti}` и `perm:{userId}:{familyId}` для затронутых пользователей.
- Для фронта/бота предусмотреть `GET /families/{id}/audit` с пагинацией (опц., MVP — только хранение).
- Лимит хранения и очистка старых записей (`TTL` или `archiver`).

Приёмочные критерии
- При изменении роли участника в сессии обновляется `capVersion`, а старые `jti` переинициализируются.
- Запись об изменении появляется в аудит-таблице.
- Нагрузочные сценарии (много изменений) не приводят к блокировке потока авторизации.

Тест‑идеи
- Unit тесты обработчиков событий: роль изменилась → audit + пересборка сессий.
- Интеграционный тест: `PATCH /members` → проверка, что в Redis обновлены capability и audit запись создана.
- Нагрузочный тест (todo) для оценки TTL и объёмов.
