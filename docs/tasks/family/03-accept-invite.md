# 03 — Принятие инвайта и привязка членства

Цель
- Подтянуть нового пользователя в существующую семью по `invitationId`, создать членство и выбрать активную семью.

Требования
- Реализовать `InvitationService.consume(invitationId, userId)` с проверками TTL, статуса и ролей.
- Создать `Member` (роль и права из инвайта, статус `active`), обновить `preferredFamilyId` пользователя на целевую семью.
- Обновить `capVersion` / `perm:{userId}:{familyId}` чтобы авторизация сразу видела права.
- Если инвайт невалиден — кидать `goneError()` или `notFoundError()`.
- Принимать id приглашённого `personId?` для будущей привязки (если указано) — сохранять в `Member`.

Интеграция
- Шаг вызывается в подтверждении Telegram, если `invitationId` присутствует в `PendingSession`.
- Возвращает `family`, `member`, `role` для построения ответа и пересборки сессии.

Приёмочные критерии
- Успешное подтверждение инвайта создаёт запись в `family_members` и отмечает инвайт как использованный.
- Невалидный/просроченный инвайт приводит к корректному коду ошибки.
- При повторном подтверждении того же `sid` не появляется второй `Member`.

Тест‑идеи
- Unit тест `InvitationService`: успешное потребление, повторное потребление → исключение.
- Сервисный тест `FamilyService`: создание участника + обновление `preferredFamilyId`.
- Интеграционный сценарий подтверждения Telegram с `invitationId`.
