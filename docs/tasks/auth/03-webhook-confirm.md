# 03 — Telegram webhook: подтверждение `/start <sid>`

Цель
- Обработать апдейт Telegram с командой `/start <sid>`, подтвердить «ожидающую сессию» внутри приложения (без внешнего HTTP‑вызова).

Требования
- Эндпоинт webhook (например, `POST /telegram/webhook`) с проверкой `X-Telegram-Bot-Api-Secret-Token`.
- Парсинг `sid` из текста `/start`.
- Идемпотентность: повторный апдейт для того же `sid` не ломает состояние.
- Логика подтверждения:
  - Проверить `sid` (существует, не истёк, не использован).
  - Найти/создать пользователя по `telegramId` (и атрибутам, если нужны: username, first_name, photo_url).
  - Если сессия связана с `invitationId` — принять инвайт и определить активную семью.
  - Создать серверную сессию (`jti`), подготовить `AuthResponse` и сохранить в `tg:pending:{sid}` как `ready`.
- Ответ пользователю в Telegram (успех/ошибка) — короткое сообщение.

Приёмочные критерии
- Валидный webhook с корректным секретом проводит подтверждение и переводит `sid` в `ready`.
- Неверный секрет → 401, состояние `sid` не меняется.
- Повторный апдейт → не меняет готовую запись, остаётся `ready`.

Тест‑идеи
- Webhook с корректным `/start <sid>` и секретом.
- Webhook без секрета/с неверным секретом.
- Повторная доставка одного и того же апдейта.

