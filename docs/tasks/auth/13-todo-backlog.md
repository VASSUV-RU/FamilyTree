# 13 — Backlog по TODO авторизации

Ниже собраны текущие TODO в коде, требующие доработки. Каждая задача нужна, чтобы довести авторизационный поток до production‑готовности.

## ft-auth-03 — Создание пользователя и подготовка сессии в confirmStart
- Конкретное место: `app/service/src/main/kotlin/ru/vassuv/familytree/service/auth/TelegramService.kt` (метод `confirmStart`, TODO на строках рядом с 129).
- Что сделать:
  - Найти пользователя по `telegramId`. На его отсутствие реагировать созданием записи (минимум: `telegramId`, `username`, `firstName`, `lastName`).
  - Привязать созданного пользователя к инвайту: принять приглашение, переключить активную семью, сохранить членство.
  - Подготовить серверную сессию заранее (сгенерировать `jti`/`rid`, записать в `PendingSessionRecord.auth` или отдельное поле) так, чтобы при поллинге не требовалось дополнительных действий.
- Приёмочные критерии: повторное подтверждение идемпотентно; при наличии инвайта создаётся членство, активная семья назначена; пользователь сохраняется в БД с актуальными данными.

## ft-auth-05 — Пользователь и ключи для Telegram-сессий/JWT
- Локации: `TokenService.issueForTelegram` (`app/service/.../TokenService.kt:49`) и `JwtService.loadOrGenerateKeyPair` (`app/service/.../JwtService.kt:125`).
- Что сделать:
  - Заменить временную логику `userId = telegramId` на настоящую привязку к пользователю БД (создание/поиск, связь с Telegram аккаунтом).
  - Обеспечить обязательную подачу ключей RSA/EC через конфигурацию (секреты). Для dev оставить fallback, но PROD должен падать без ключей.
  - Обновить тесты/конфигурацию, чтобы покрывать оба сценария (dev/prod).
- Приёмочные критерии: интеграционный тест охватывает создание пользователя + выдачу токенов; при пустых ключах в prod-профиле приложение не стартует.

## ft-auth-08 — Проверка членства при смене активной семьи
- Локация: `TokenService.switchActiveFamily` (`app/service/.../TokenService.kt:245`).
- Что сделать:
  - Реализовать проверку, что `userId` состоит в `familyId` с нужной ролью/правами.
  - Пересчитать `scopes`/доступ и сохранить в `SessionEntity` + `CachedSession`.
  - Обновить refresh-логика с учётом возможной смены разрешений.
- Приёмочные критерии: тесты на успешное переключение при наличии членства и на отказ при его отсутствии.

## ft-auth-09 — Приём инвайта
- Локация: `DefaultInvitationService.accept` (`app/service/src/main/kotlin/ru/vassuv/familytree/service/invite/DefaultInvitationService.kt`).
- Что сделать:
  - Реализовать поиск инвайта, проверки статуса и срока действия.
  - Создать членство пользователя в семье, вернуть `familyId`, обновить состояние инвайта.
  - Учесть конфликтные случаи (инвайт просрочен, уже принят) и возвращать корректные исключения.
- Приёмочные критерии: сервисные тесты на успешный сценарий и ошибки; интеграция с `TokenService.issueForTelegram` и `TelegramService.confirmStart`.

## Дополнительно
- Пересмотреть TODO `ft-auth-05` в `JwtService` — при прод-профиле загружать ключи только из PEM.
- Убедиться, что документация (`docs/tasks/auth/*`) синхронизирована с этими задачами при выполнении.

