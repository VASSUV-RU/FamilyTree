# Authorization

Данные описывают процесс входа в систему и управление сессиями.

## Цели
- Выдать короткоживущий access-JWT.
- Создать/обновить серверную сессию в кеше.
- Вернуть клиенту набор прав по активной семье.
- Минимизировать содержимое JWT.

## Сценарии входа
1. Первичный вход через Telegram Login.
2. Обновление access по refresh-cookie.
3. Смена активной семьи без повторной аутентификации.
4. Выход и отзыв сессий.

## Контракты API
### `POST /auth/telegram/verify`
- Верификация подписи Telegram, создание пользователя и сессии.
- Ответ включает `accessToken`, `expiresIn`, сведения о пользователе и права.
- Возможные ошибки: `401 INVALID_TELEGRAM_SIGNATURE`, `400 STALE_AUTH_DATE`, `429 TOO_MANY_ATTEMPTS`.

### `POST /auth/refresh`
- Выдача нового access по refresh-cookie и ротация сессии.

### `POST /me/active-family`
- Переключение активной семьи, пересчёт прав.

### `POST /auth/logout`
- Удаление текущей сессии и её отзыв.

## Алгоритм Telegram Verify
1. Сформировать строку данных из payload (кроме `hash`), отсортировать и склеить `key=value`.
2. Ключ HMAC: `SHA256(bot_token)`.
3. Сравнить вычисленный HMAC-SHA256 с переданным `hash`.
4. Проверить `auth_date` на "свежеcть".
5. Найти/создать пользователя, определить активную семью.
6. Загрузить пермишены, создать серверную сессию, выдать JWT и refresh-cookie.

## Access JWT
- Клеймы: `sub`, `jti`, `iat`, `exp`.
- Подпись `RS256/ES256`, размер ≤ 2 KB.
- Проверка: подпись, срок действия, поиск `sess:{jti}` в Redis, возможный DB fallback.

## Refresh-поток
- Refresh-cookie: `httpOnly`, `Secure`, `SameSite=Lax/Strict`, TTL 7–30 дней.
- При refresh выполняется ротация `jti`, пересоздание сессии и отзыв старой.

## Смена активной семьи
- Проверка членства пользователя.
- Загрузка пресетов и пересчёт `scopes`.
- Обновление `sess:{jti}` и выдача нового access-JWT.

## Обновление прав в онлайне
- Изменение ролей → обновление `perm:{userId}:{familyId}` и `capVersion`.
- Push: обновление активных сессий.
- Lazy: пересборка сессии при запросе, если версия устарела.

## Безопасность и лимиты
- Rate limit на `telegram/verify`.
- Защита от replay: окно для `auth_date` и одноразовость payload.
- Аудит действий входа/выхода.
- При отказе кэша — один DB fallback, затем 503/403.
- CORS/CSRF: access в `Authorization` header, refresh через cookie и CSRF token.

## Открытые вопросы
- Окно допустимого `auth_date`.
- TTL access-JWT.
- Стратегия ротации refresh.
- Выбор первой активной семьи.
- Хранение индекса для массового отзыва `jti`.

