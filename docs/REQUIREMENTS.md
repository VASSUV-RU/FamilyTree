# Требования к проекту Family‑Tree

Документ описывает цели, функциональные и нефункциональные требования к бэкенду Family‑Tree (Kotlin + Spring Boot, PostgreSQL, Docker) и ожидаемый результат (MVP → расширение).

## Цели
- Хранить доменные данные семьи (семьи, участники, роли, связи, источники медиа) и предоставлять API для фронтенда/ботов.
- Интегрироваться с внешними хранилищами (без копирования файлов), синхронизировать метаданные и выдавать ссылки/токены фронтенду.
- Обеспечить прозрачную модель ролей/пермишенов и безопасный доступ.

## Зона MVP
- Пользователь может войти через Telegram и выбрать/создать активную семью.
- Владелец семьи приглашает участников, назначает роли (`owner`, `admin`, `member`, `guest`).
- Список источников медиа (например, Telegram, Яндекс.Диск) подключается, запускается синхронизация метаданных, фронтенд получает список медиа и ссылки для доступа во внешних сервисах.
- Просмотр, комментарии к медиа (минимально: создать комментарий, список комментариев). Модерация комментариев для ролей с правом.
- Базовые сущности и операции над ними задокументированы в `docs/*` и стабильны.

## Функциональные требования
- Аутентификация/авторизация
  - Вход через Telegram‑бот (deep‑link) с «ожидающей сессией»; обновление `access` по `refresh` (JWT). См. [docs/guides/authorization/README.md](docs/guides/authorization/README.md).
  - Хранение и выбор активной семьи пользователем.
  - Роли и права: см. [docs/reference/roles.md](docs/reference/roles.md), [docs/reference/permissions.md](docs/reference/permissions.md).
- Семьи и участники
  - CRUD семьи (создать, получить, обновить, удалить — удаление доступно владельцу).
  - Управление участниками: добавление по приглашению, изменение роли, удаление. См. [docs/guides/family/*](docs/guides/family/).
  - Приглашения: генерация, принятие, отзыв; интеграция с Telegram‑ботом.
- Источники и медиа
  - Подключение источника (минимум один: Telegram или Яндекс.Диск) и хранение конфигурации подключений.
  - Синхронизация метаданных (без переноса файлов) и публикация каталога медиа через API.
  - Комментарии к медиа: создать/список; модерация для `owner/admin`.
- Генеалогия (минимум)
  - Базовая модель людей и связей родства; операции чтения. Удаление/изменение — только у ролей с соответствующими правами.

## Нефункциональные требования
- Безопасность
  - Не хранить секреты в репозитории; использовать переменные окружения и `application-local.yml` (в `.gitignore`), пример в `application-local.example.yml`.
  - Минимальные права БД, валидация и санитизация входных данных, аудит ключевых действий.
- Качество/поддержка
  - Чёткая документация API и домена в `docs/*`, перекрёстные ссылки актуальны.
  - Conventional Commits; маленькие, однотематические PR с обновлённой документацией.
  - Базовые тесты на ключевые сервисы и авторизацию (по мере появления кода).
- Эксплуатация
  - Контейнеризация (Dockerfile + docker-compose для локального запуска с PostgreSQL).
  - Конфигурация через ENV/`application.yml`. Профили: `local`, `dev`, `prod`.
  - Redis — хранение серверных сессий и блок‑листа JWT (`sess:{jti}`, `blk:{jti}`), защита от повторов (`used_hash:{hash}`).

## API (верхнеуровневой срез)
- Auth: `POST /auth/telegram/session`, `GET /auth/telegram/session/{sid}`, `POST /auth/refresh`, `POST /auth/logout`, `POST /me/active-family`.
- Families: `POST /families`, `GET/PATCH/DELETE /families/{id}` (опц. `GET /families` — список семей пользователя).
- Members: `GET/PATCH/DELETE /families/{id}/members` (добавление — через Invites).
- Invites: `POST/GET /families/{id}/invites`, `POST /invites/{token}/accept`, `DELETE /families/{id}/invites/{inviteId}`.
- Media: список, комментарии (минимальная версия).

## Схемы данных
Справочник сущностей: [docs/reference/entities/*](docs/reference/entities/).

## Критерии готовности (MVP)
- Реализованы и задокументированы сценарии из разделов «Зона MVP» и «API».
- Роли/права применяются на уровне эндпоинтов и бизнес‑логики, таблица доступов соответствует `docs/reference/roles.md`.
- Возможен локальный запуск (Docker/PostgreSQL) и базовая синхронизация хотя бы с одним источником.
- Минимальный набор тестов проходит; линт/сборка зелёные.

## Вне рамок MVP (можно позже)
- Расширенная модерация и права на уровне объектов медиа.
- Импорт/экспорт дерева родства, визуализации.
- Поддержка дополнительных источников и очередей (Kafka/RabbitMQ).
